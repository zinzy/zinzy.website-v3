<!-- 
    script: https://quinncasey.com/hugo-wikilink-support/ 
    https://justinmiller.io/posts/2023/12/27/hugo-as-wiki/

    Prints page content with two types of wikilinks rendered (with and without text).
	
	Based loosely on https://github.com/milafrerichs/hugo-wikilinks with these improvements:
		- Renders shortcodes correctly
		- Handles Links with text
		- Uses safeHTML instead of markdownify (renders <code></code> blocks correctly)

	This is redundant once a solution is developed for https://github.com/gohugoio/hugo/issues/3606

    @author @qcasey

    @context Type Page (.)

    @access public

-->

{{ $wikiregexWithText := "\\[\\[([^\\]\\|\\r\\n]+?)\\|([^\\]\\|\\r\\n]+?)\\]\\]" }}
{{ $wikiregex := "\\[\\[([^\\]\\|\\r\\n]+?)\\]\\]" }}

{{ $page := .Page }}
{{ $pageContent := .Content }}

<!-- Loop for wikilinks -->
{{ range ($wikilinks := .Content | findRE $wikiregex) }} 

    <!-- Variables -->

    <!-- Replace anything in $link matching the content from $wikiregex -->
	{{ $link := . | replaceRE $wikiregex "$1" }} 
	{{ $wikilink :=  printf "\\[\\[%s\\]\\]" $link }}

    <!-- Function:  -->
    {{ with relref $page $link }}
        <!-- Format $link -->
        {{ $link := printf "%s%s%s%s%s" "<a href=\"" . "\">" ($.Site.GetPage $link).Title "</a>"  }}
        <!-- Replace the wiki link with the HTML link -->
        {{ $pageContent = $pageContent | replaceRE $wikilink $link }}
    {{ end }}
{{ end }}


{{ range ($pageContent | findRE $wikiregexWithText) }}

    <!-- Variables -->
	{{ $link := . | replaceRE $wikiregexWithText "$1" }}
	{{ $text := . | replaceRE $wikiregexWithText "$2" }}
	{{ $wikilink :=  printf "\\[\\[%s\\|%s\\]\\]" $link $text }}

    <!-- Function -->	
    {{ with relref $page $link }}
        {{ $link := printf "%s%s%s%s%s" "<a href=\"" . "\">" $text "</a>" }}
        {{ $pageContent = $pageContent | replaceRE $wikilink $link }}
    {{ end }}
{{ end }}

{{ $pageContent | safeHTML }}